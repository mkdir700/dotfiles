# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH
#
[ -f ~/.env ] && source ~/.env

# ---- PATH 去重（zsh 最佳实践）----
typeset -U path PATH


# ---- 用户级 bin（最高优先级）----
path=(
  $HOME/bin
  $HOME/.local/bin

  # Rust
  $HOME/.cargo/bin

  # Node
  $HOME/.npm-global/bin
  $HOME/Library/pnpm
  $HOME/.bun/bin

  # Solana toolchain
  $HOME/.local/share/solana/install/active_release/bin

  # Flutter
  $HOME/flutter/bin

  # Go
  $HOME/go/bin

  # Python user scripts
  $HOME/Library/Python/3.10/bin
  $HOME/Library/Python/3.8/bin

  # Pixi
  $HOME/.pixi/bin

  # Windsurf / Cartesia / Antigravity
  $HOME/.codeium/windsurf/bin
  $HOME/.cartesia/bin
  $HOME/.antigravity/antigravity/bin

  # x-cmd
  $HOME/.x-cmd.root/local/data/pkg/sphere/X/l/j/h/bin
  $HOME/.x-cmd.root/bin

  # LLVM (brew llvm toolchain)
  /opt/homebrew/opt/llvm/bin

  # Homebrew Apple Silicon
  /opt/homebrew/bin

  # Intel brew fallback
  /usr/local/bin

  $path
)

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time Oh My Zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
ZSH_THEME="robbyrussell"

# Set list of themes to pick from when loading at random
# Setting this variable when ZSH_THEME=random will cause zsh to load
# a theme from this variable instead of looking in $ZSH/themes/
# If set to an empty array, this variable will have no effect.
# ZSH_THEME_RANDOM_CANDIDATES=( "robbyrussell" "agnoster" )

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
# zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
# ENABLE_CORRECTION="true"

# Uncomment the following line to display red dots whilst waiting for completion.
# You can also set it to another string to have that shown instead of the default red dots.
# e.g. COMPLETION_WAITING_DOTS="%F{yellow}waiting...%f"
# Caution: this setting can cause issues with multiline prompts in zsh < 5.7.1 (see #5765)
# COMPLETION_WAITING_DOTS="true"

# Uncomment the following line if you want to disable marking untracked files
# under VCS as dirty. This makes repository status check for large repositories
# much, much faster.
# DISABLE_UNTRACKED_FILES_DIRTY="true"

# Uncomment the following line if you want to change the command execution time
# stamp shown in the history command output.
# You can set one of the optional three formats:
# "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
# or set a custom format using the strftime function format specifications,
# see 'man strftime' for details.
# HIST_STAMPS="mm/dd/yyyy"

# Would you like to use another custom folder than $ZSH/custom?
# ZSH_CUSTOM=/path/to/new-custom-folder

# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(git)

source $ZSH/oh-my-zsh.sh

# User configuration

# OpenSpec shell completions
fpath=("$HOME/.zsh/completions" $fpath)

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
if [[ -n $SSH_CONNECTION ]]; then
  export EDITOR='vim'
else
  export EDITOR='nvim'
fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# Set personal aliases, overriding those provided by Oh My Zsh libs,
# plugins, and themes. Aliases can be placed here, though Oh My Zsh
# users are encouraged to define aliases within a top-level file in
# the $ZSH_CUSTOM folder, with .zsh extension. Examples:
# - $ZSH_CUSTOM/aliases.zsh
# - $ZSH_CUSTOM/macos.zsh
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
alias ohmyzsh="mate ~/.oh-my-zsh"

[ ! -f "$HOME/.x-cmd.root/X" ] || . "$HOME/.x-cmd.root/X"

### Added by Zinit's installer
if [[ ! -f $HOME/.local/share/zinit/zinit.git/zinit.zsh ]]; then
    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})…%f"
    command mkdir -p "$HOME/.local/share/zinit" && command chmod g-rwX "$HOME/.local/share/zinit"
    command git clone https://github.com/zdharma-continuum/zinit "$HOME/.local/share/zinit/zinit.git" && \
        print -P "%F{33} %F{34}Installation successful.%f%b" || \
        print -P "%F{160} The clone has failed.%f%b"
fi

source "$HOME/.local/share/zinit/zinit.git/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# Load a few important annexes, without Turbo
# (this is currently required for annexes)
zinit light-mode for \
    zdharma-continuum/zinit-annex-as-monitor \
    zdharma-continuum/zinit-annex-bin-gem-node \
    zdharma-continuum/zinit-annex-patch-dl \
    zdharma-continuum/zinit-annex-rust

zinit light zsh-users/zsh-autosuggestions
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light rupa/z

# fzf shell integration
eval "$(fzf --zsh)"

eval "$(starship init zsh)"
### End of Zinit's installer chunk

##### 基础：Vim 模式 + 历史/键位 #####
bindkey -v

# 插入模式：竖条；普通模式：方块
function _vi_update_cursor() {
  case $KEYMAP in
    vicmd)      # normal 模式
      echo -ne '\e[2 q'
      ;;
    main|viins) # insert 模式
      echo -ne '\e[5 q'
      ;;
  esac
}

zle -N zle-keymap-select _vi_update_cursor
zle -N zle-line-init _vi_update_cursor
precmd_functions+=(_vi_update_cursor)

export KEYTIMEOUT=1
export HISTSIZE=200000
export SAVEHIST=200000
setopt HIST_IGNORE_ALL_DUPS HIST_FIND_NO_DUPS SHARE_HISTORY

##### fzf 基本环境 #####
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git 2>/dev/null'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_DEFAULT_OPTS='--height=80% --min-height=15 --layout=reverse --border --exit-0'

# 让补全进入菜单选择并可用方向键/Tab 导航
zmodload zsh/complist
setopt AUTO_LIST AUTO_MENU COMPLETE_IN_WORD ALWAYS_TO_END
unsetopt MENU_COMPLETE
bindkey "^[[Z" reverse-menu-complete

##### 匹配策略 #####
zstyle ':completion:*' matcher-list \
  'm:{a-z}={A-Za-z}' \
  'r:|[._-]=** r:|=**' \
  'l:|=*'

##### 外观与分组 #####
zstyle ':completion:*' menu select=long-list
zstyle ':completion:*' list-prompt '%S%M matches%s'
zstyle ':completion:*' select-prompt '%SScrolling: current %p%s'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' group-order \
  'arguments' 'options' 'commands' 'aliases' 'functions' 'variables' \
  'files' 'directories'

# fzf-tab（如果存在）
if [[ -f "$HOME/.zsh/plugins/fzf-tab/fzf-tab.zsh" ]]; then
  source "$HOME/.zsh/plugins/fzf-tab/fzf-tab.zsh"
  zstyle ':fzf-tab:*' fzf-flags --height=85% --min-height=15 --layout=reverse --border --ansi --info=inline --preview-window=right:55%:wrap
  zstyle ':fzf-tab:*' switch-group '<' '>'
  _preview_file='( command -v batcat >/dev/null && echo "batcat --style=plain --color=always --paging=never --line-range :300 -- {}" ) || ( command -v bat >/dev/null && echo "bat --style=plain --color=always --paging=never --line-range :300 -- {}" ) || echo "head -n 300 -- {}"'
  zstyle ':fzf-tab:complete:*:*' preview "$_preview_file"
  zstyle ':fzf-tab:complete:cd:*' preview 'ls -la --color=always --group-directories-first -- $realpath'
fi

# 加载 edit-command-line 小部件
autoload -Uz edit-command-line
zle -N edit-command-line

# vi insert 常用键位
bindkey -M viins '^?' backward-delete-char
bindkey -M viins '^H' backward-delete-char
bindkey -M viins '^N' down-line-or-history
bindkey -M viins '^P' up-line-or-history
bindkey -M viins '^B' backward-char
bindkey -M viins '^F' forward-char
bindkey -M viins '^U' kill-whole-line
bindkey -M viins '^K' kill-line
bindkey -M viins '^A' beginning-of-line
bindkey -M viins '^E' end-of-line
bindkey -M viins '^W' backward-kill-word
bindkey -M viins '^D' delete-char
bindkey -M viins '^_' undo
bindkey -M viins '^X^E' edit-command-line
bindkey -M vicmd '^X^E' edit-command-line

alias ls='exa --icons --group-directories-first --sort=modified'
alias ll='exa --icons --group-directories-first --sort=modified --long'
alias l='exa --icons --group-directories-first --sort=modified --long --level=1'
alias cls='clear'
alias lz='lazygit'
alias cz='chezmoi'

## NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

# bun completions
[ -s "$HOME/.bun/_bun" ] && source "$HOME/.bun/_bun"

if command -v wt >/dev/null 2>&1; then
  eval "$(command wt config shell init zsh)"
fi

# OpenClaw Completion
[ -f "$HOME/.openclaw/completions/openclaw.zsh" ] && source "$HOME/.openclaw/completions/openclaw.zsh"

# Wake external/internal display (macOS)
wake-display() {
  caffeinate -u -t 2
}
